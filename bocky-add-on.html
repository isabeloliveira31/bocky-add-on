<!DOCTYPE html>
<html>
  <head>
    <title>Bocky Popup Widget</title>
    <meta charset="utf-8">
    <meta name="description" content="Bocky Popup Widget">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="bocky-add-on.css">
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  </head>
  <body>
    <button id="bocky-icon" class="open" type="button" onclick="abrirConversa()" aria-label="Open Bocky widget">
        <img id="bocky-icon-img" src="icons/bocky-icon.png">
    </button>
    <div id="chatbot-conversa">
        <div id="bocky-conversa-header" class="chatbot-conversa-header">
            <!--widget's top section - contém o ícone e nome e o botão de esconder a conversa -->
            <a class="header-link-icon" href="https://app-backend-tyifxu7gn33ba.azurewebsites.net/" aria-label="Open Bocky page">
                <img src="icons/bocky-icon.png">
                <p>Bocky</p>
            </a>
            <button id="button-copilot-engine" class="change-engine" type="button" onclick="chooseEngine('copilot')" aria-label="Select chat powered by Copilot">
                <img class="change-engine-img icon" src="icons/copilot-icon.png" width="15px" height="15px">
                <p>Alterar para chat Copilot</p>
            </button>
            <button class="chatbot-conversa-close" type="button" onclick="esconderConversa()" aria-label="Esconder Bocky Widget">
                <img src="icons/close-icon.png" width="15px" height="15px" aria-label="hide chat button">
            </button>
        </div>
        <div id="copilot-conversa-header" class="chatbot-conversa-header hidden">
            <!--widget's top section - contém o ícone e nome e o botão de esconder a conversa -->
            <a class="header-link-icon" href="https://m365.cloud.microsoft/" aria-label="Open Copilot page">
                <img src="icons/copilot-icon.png">
                <p>Copilot</p>
            </a>
            <button id="button-bocky-engine" class="change-engine" type="button" onclick="chooseEngine('bocky')" aria-label="Select chat powered by Bocky">
                <img class="change-engine-img icon" src="icons/bocky-icon.png" width="15px" height="15px">
                <p>Alterar para chat Bocky</p>
            </button>
            <button class="chatbot-conversa-close" type="button" onclick="esconderConversa()" aria-label="Esconder Bocky Widget">
                <img src="icons/close-icon.png" width="15px" height="15px" aria-label="hide chat button">
            </button>
        </div>
        <div id="historico-conversa-bocky" class="historico-conversa">
            <!-- secção onde se pode ver as mensagens anteriores do bocky-->
        </div>
        <div id="historico-conversa-copilot" class="historico-conversa" style="display: none;">
            <!-- secção onde se pode ver as mensagens anteriores do copilot-->
        </div>
        <div id="bocky-widget-prompt-section">
            <!-- widget's bottom section - contains the user's input textbox and the send button -->
            <textarea id="bocky-widget-prompt" rows="2" placeholder="Escreve uma mensagem para o Bocky" aria-label="Write Bocky prompt" onkeydown="if(event.key === 'Enter'){event.preventDefault(); sendPrompt();}" required="required" spellcheck="false"></textarea>
        </div>
        <p id="aviso-podem-ocorrer-erros">Respostas geradas por Inteligência Artificial. Podem ocorrer erros.</p>
    </div>
    <script type="text/javascript" src="bocky-add-on.js"></script>

    <script>
        async function sendPrompt() {
            document.getElementById('chatbot-conversa').style.cursor ='wait';
            const signedIn = await isSignedIn();
            document.getElementById('chatbot-conversa').style.cursor ='default';
            if (!signedIn) {
                removeSendButton();
                return;
            }

            const promptIsntEmpty = prompt_textarea.value.trim().length > 0;
            if (promptIsntEmpty){
                addSendButton();

                sendButtonAnimation();
                const prompt = getPromptAndClearInputTextbox();

                const isEngineBocky = document.getElementById('copilot-conversa-header').classList.contains('hidden');
                const engine = isEngineBocky ? 'bocky' : 'copilot';

                drawUserText(prompt, engine);
                
                if(isEngineBocky){
                    const token = await fetchToken();
                    if (token == null){
                        console.error("Failed at getting user's authentication token.");
                        return;
                    }
                    const response = await getBockyEngineAnswer(token, prompt);
                    if (response == null){
                        console.error("Failed at getting bocky response.");
                        return;
                    }
                    drawResponseText(response.message, 'bocky');
                }
                else {
                    const response = await getCopilotEngineAnswer(prompt);
                    if (response == null){
                        console.error("Failed at getting a response from Copilot Bocky.");
                        return;
                    }
                    drawResponseText(response.message, 'copilot');
                }
                resizeIframeToConversaBocky();
            } else {
                removeSendButton();
            }
        }

        function drawResponseText(response, engine){
            // draws response text
            const message = document.createElement('div');
            const messageBalloon = document.createElement('div');
            const messageText = document.createElement('p');
            const timestamp = document.createElement('p');
            message.classList.add('mensagem-conversa');
            message.classList.add('mensagem-conversa-bocky');
            messageBalloon.classList.add('message-balloon');
            messageText.textContent = response;
            const timestamp_string =  getTimestamp();
            timestamp.textContent = timestamp_string;
            timestamp.classList.add('message-timestamp');

            messageBalloon.appendChild(messageText);
            message.appendChild(messageBalloon);
            message.appendChild(timestamp);
            if(engine == 'bocky'){
                document.getElementById('historico-conversa-bocky').appendChild(message);
                // update scroll position to the latest message
                document.getElementById('historico-conversa-bocky').scrollTop = document.getElementById('historico-conversa-bocky').scrollHeight;
                // tto test later document.getElementById('historico-conversa').scrollTop += 100;
            } else if (engine == 'copilot'){
                document.getElementById('historico-conversa-copilot').appendChild(message);
                // update scroll position to the latest message
                document.getElementById('historico-conversa-copilot').scrollTop = document.getElementById('historico-conversa-copilot').scrollHeight;
                // to test later document.getElementById('historico-conversa').scrollTop += 100;
            }
            resizeIframeToConversaBocky();
        }
    </script>
  </body>
</html>