<!DOCTYPE html>
<html>
  <head>
    <title>Bocky Popup Widget</title>
    <meta charset="utf-8">
    <meta name="description" content="Bocky Popup Widget">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="bocky-add-on.css">
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  </head>
  <body>
    <button id="bocky-icon" class="open" type="button" onclick="abrirConversa()" aria-label="Open Bocky widget">
        <img src="icons/bocky-icon.png">
    </button>
    <div id="bocky-conversa">
        <div id="bocky-conversa-header">
            <!--widget's top section - contém o ícone e nome e o botão de esconder a conversa -->
            <a id="bocky-link-icon" href="https://app-backend-tyifxu7gn33ba.azurewebsites.net/" aria-label="Open Bocky page">
                <img src="icons/bocky-icon.png">
                <p class=".heading-6">Bocky</p>
            </a>
            <div id="choose-bocky-engine">
                <button class="bocky-engine" id="bocky-engine-copilot" type="button" onclick="chooseBockyEngine('copilot')" aria-label="Select Bocky powered by Copilot">
                    <img class="icon" src="icons/copilot-icon.png">
                    <p>Copilot</p>
                </button>
                <button class="bocky-engine selected" id="bocky-engine-traditional" type="button" onclick="chooseBockyEngine('traditional')" aria-label="Select traditional Bocky">
                    <img class="icon" src="icons/bocky-icon.png">
                    <p>Traditional</p>
                </button>
            </div>
            <button id="bocky-conversa-close" type="button" onclick="esconderConversa()" aria-label="Esconder Bocky Widget">
                <img src="icons/close-icon.png" width="15px" height="15px" aria-label="hide chat button">
            </button>
        </div>
        <div id="historico-conversa">
            <!-- secção onde se pode ver as mensagens anteriores-->
        </div>
        <div id="bocky-widget-prompt-section">
            <!-- widget's bottom section - contains the user's input textbox and the send button -->
            <textarea id="bocky-widget-prompt" rows="3" placeholder="Escreve uma mensagem para o Bocky" aria-label="Write Bocky prompt" onkeydown="if(event.key === 'Enter'){event.preventDefault(); sendPrompt();}" required="required" spellcheck="false"></textarea>
        </div>
        <p id="aviso-podem-ocorrer-erros">Respostas geradas por Inteligência Artificial. Podem ocorrer erros.</p>
    </div>
    <script type="text/javascript" src="bocky-add-on.js"></script>

    <script>
        async function sendPrompt() {
            document.getElementById('bocky-conversa').style.cursor ='wait';
            const signedIn = await isSignedIn();
            document.getElementById('bocky-conversa').style.cursor ='default';
            if (!signedIn) {
                removeSendButton();
                return;
            }

            const promptIsntEmpty = prompt_textarea.value.trim().length > 0;
            if (promptIsntEmpty){
                addSendButton();

                sendButtonAnimation();
                const prompt = getPromptAndClearInputTextbox();
                drawUserText(prompt);

                const useTraditionalBockyEngine = document.getElementById('bocky-engine-traditional').classList.contains('selected');
                
                if(useTraditionalBockyEngine){
                    const token = await fetchToken();
                    if (token == null){
                        console.error("Failed at getting user's authentication token.");
                        return;
                    }
                    const response = await getBockyEngineAnswer(token, prompt);
                    if (response == null){
                        console.error("Failed at getting bocky response.");
                        return;
                    }
                    drawResponseText(response.message, 'traditional');
                }
                else {
                    const response = await getCopilotEngineAnswer(prompt);
                    if (response == null){
                        console.error("Failed at getting a response from Copilot Bocky.");
                        return;
                    }
                    drawResponseText(response.message, 'copilot');
                }
            } else {
                removeSendButton();
            }
        }

        function drawResponseText(response, engine){
            // draws response text
            const iconBockyEngine = document.createElement('img');
            iconBockyEngine.classList.add('icon');
            if (engine == 'traditional'){
                iconBockyEngine.src = 'icons/bocky-icon.png';
                iconBockyEngine.alt = 'Traditional Bocky icon';
            } else if (engine == 'copilot') {
                iconBockyEngine.src = 'icons/copilot-icon.png';
                iconBockyEngine.alt = 'Copilot Bocky icon';
            }
            const message = document.createElement('div');
            const messageBalloon = document.createElement('div');
            const messageText = document.createElement('p');
            const timestamp = document.createElement('p');
            message.classList.add('mensagem-conversa');
            message.classList.add('mensagem-conversa-bocky');
            messageBalloon.classList.add('message-balloon');
            messageText.textContent = response;
            const timestamp_string =  getTimestamp();
            timestamp.textContent = timestamp_string;
            timestamp.classList.add('message-timestamp');

            messageBalloon.appendChild(messageText);
            // hide the icon - it will be problably removed
            //messageBalloon.appendChild(iconBockyEngine);
            message.appendChild(messageBalloon);
            message.appendChild(timestamp);
            document.getElementById('historico-conversa').appendChild(message);

            // update scroll position to the latest message
            document.getElementById('historico-conversa').scrollTop = document.getElementById('historico-conversa').scrollHeight;
            // tto test later document.getElementById('historico-conversa').scrollTop += 100;
            requestAnimationFrame(() => resizeIframeToConversaBocky());
        }
    </script>
  </body>
</html>