<!DOCTYPE html>
<html>
  <head>
    <title>Bocky Popup Widget</title>
    <meta charset="utf-8">
    <meta name="description" content="Bocky Popup Widget">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="bocky-add-on.css">
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  </head>
  <body>
    <button id="bocky-icon" class="open" type="button" onclick="abrirConversa()" aria-label="Open Bocky widget">
        <img id="bocky-icon-img" src="icons/bocky-icon.png">
    </button>
    <div id="chatbot-conversa">
        <div id="bocky-conversa-header" class="chatbot-conversa-header">
            <!--widget's top section - contém o ícone e nome e o botão de esconder a conversa -->
            <a class="header-link-icon" href="https://app-backend-tyifxu7gn33ba.azurewebsites.net/" target='_blank' aria-label="Open Bocky page">
                <img src="icons/bocky-icon.png">
                <p>Bocky</p>
            </a>
            <button class="delete-chatbot-conversation" type="button" onclick="apagarConversa('bocky')" aria-label="Apagar histórico da conversa com o Bocky">
                <img src="icons/trash-icon.svg">
                <p>Apagar Conversa</p>
            </button>
            <button class="chatbot-conversa-close" type="button" onclick="esconderConversa()" aria-label="Esconder Bocky Widget">
                <img src="icons/close-icon.png" width="15px" height="15px" aria-label="hide chat button">
            </button>
        </div>
        <div id="historico-conversa-bocky" class="historico-conversa">
            <!-- secção onde se pode ver as mensagens anteriores do bocky-->
        </div>
        <div id="chatbot-widget-prompt-section">
            <!-- widget's bottom section - contains the user's input textbox and the send button -->
            <textarea id="chatbot-widget-prompt" placeholder="Escreve uma mensagem para o Bocky" aria-label="Write Bocky prompt" onkeydown="if(event.key === 'Enter'){event.preventDefault(); sendPrompt();}" required="required" spellcheck="false"></textarea>
        </div>
        <p id="aviso-podem-ocorrer-erros">Respostas geradas por Inteligência Artificial. Podem ocorrer erros. Este conteúdo é baseado em dados fornecidos pela portal +Digital</p>
    </div>
    <script type="text/javascript" src="bocky-add-on.js"></script>
    <script>
        async function getBockyEngineAnswer(){
            const mock_response = {"choices": [{"message": {"content": "Ol\u00e1! Sou o Bocky. Em que posso ajud\u00e1-lo?\n\nPara marcar f\u00e9rias, voc\u00ea pode utilizar o sistema da aplica\u00e7\u00e3o \"F\u00e9rias\". Aqui est\u00e3o os passos principais:\n\n1. **Registro do Pedido**: Utilize a funcionalidade **SaveVacationsToApprove** para registrar os dias de f\u00e9rias desejados. O pedido ficar\u00e1 pendente de aprova\u00e7\u00e3o pela chefia [Manual de utilizador_Férias.pdf].\n\n2. **Aprova\u00e7\u00e3o Autom\u00e1tica**: Se voc\u00ea pertence a um grupo funcional com aprova\u00e7\u00e3o autom\u00e1tica, o pedido ser\u00e1 aprovado automaticamente e registrado diretamente no sistema SAP atrav\u00e9s da a\u00e7\u00e3o **SubmitVacationsToSAP** [Manual de utilizador_Férias.pdf].\n\n3. **Visualiza\u00e7\u00e3o e Gest\u00e3o**: Caso seja uma chefia, voc\u00ea pode visualizar e aprovar os pedidos da sua equipa na funcionalidade **VacationsManagement**, garantindo a gest\u00e3o eficiente das aus\u00eancias [Manual de utilizador_Férias.pdf].\n\nSe precisar de ajuda adicional ou mais detalhes[Manual da Isabel.pdf], \u00e9 s\u00f3 dizer! \ud83d\ude0a",},}],};
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(mock_response);
                }, 1000);
            }); 
        }

        async function sendPrompt() {
            const promptIsntEmpty = prompt_textarea.value.trim().length > 0;
            const sendButton = document.getElementById('send-prompt-button');
            if (promptIsntEmpty && sendButton){
                addSendButton();

                sendButtonAnimation();
                const prompt = getPromptAndClearInputTextbox();

                const isEngineBocky = isChatBocky();
                const engine = isEngineBocky ? 'bocky' : 'copilot';

                drawUserText(prompt, engine);
                
                if(isEngineBocky){
                    // update sessionStorage with the new prompt
                    let messages_bocky = JSON.parse(sessionStorage.getItem("messages_bocky"));
                    if (messages_bocky === null){
                        messages_bocky = [{content: prompt, role: "user"}];
                    } else {
                        messages_bocky.push({content: prompt, role: "user"});
                    }
                    sessionStorage.setItem("messages_bocky", JSON.stringify(messages_bocky));

                    const response = await getBockyEngineAnswer();
                    if (response == null){
                        console.error("Failed at getting a response from Bocky.");
                        drawErrorText("There was an error, please try again.", "bocky");
                        return;
                    }
                    const response_message = response.choices[0].message.content.trim();
                    const rendered_response = await renderBockyResponse(response);
                    drawResponseText(rendered_response, 'bocky');

                    // update sessionStorage with the new response
                    messages_bocky = JSON.parse(sessionStorage.getItem("messages_bocky"));
                    if (messages_bocky === null){
                        messages_bocky = [{content: response_message, role: "assistant"}];
                    } else {
                        messages_bocky.push({content: response_message, role: "assistant"});
                    }
                    sessionStorage.setItem("messages_bocky", JSON.stringify(messages_bocky));
                }
                else {
                    // update sessionStorage with the new prompt
                    let messages_copilot = JSON.parse(sessionStorage.getItem("messages_copilot"));
                    if (messages_copilot === null){
                        messages_copilot = [{content: prompt, role: "user"}];
                    } else {
                        messages_copilot.push({content: prompt, role: "user"});
                    }
                    sessionStorage.setItem("messages_copilot", JSON.stringify(messages_copilot));

                    const response = await getCopilotEngineAnswer(prompt);
                    if (response == null){
                        console.error("Failed at getting a response from Copilot.");
                        drawErrorText("There was an error, please try again.", "copilot");
                        return;
                    }
                    const response_message = response.message.trim();
                    const rendered_response = await renderCopilotResponse(response);
                    drawResponseText(rendered_response, 'copilot');

                    // update sessionStorage with the new response
                    messages_copilot = JSON.parse(sessionStorage.getItem("messages_copilot"));
                    if (messages_copilot === null){
                        messages_copilot = [{content: response_message, role: "assistant"}];
                    } else {
                        messages_copilot.push({content: response_message, role: "assistant"});
                    }
                    sessionStorage.setItem("messages_copilot", JSON.stringify(messages_copilot));
                }
                document.getElementById("chatbot-widget-prompt").dispatchEvent(new Event('input'));
                setTimeout(() => {
                    resizeIframeToConversaBocky();
                    setTimeout(() => {
                        resizeIframeToConversaBocky();
                    }, 50);
                }, 100);
            } else {
                removeSendButton();
            }
        }
    </script>
  </body>
</html>